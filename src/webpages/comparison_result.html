<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamHACK - Detailed Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-header {
            background-color: #e0e0e0;
            padding: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .subsection-header {
            background-color: #f1f1f1;
            padding: 10px 15px;
            margin-top: 25px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        .comparison-table tr.conflict {
            background-color: rgba(255, 0, 0, 0.08);
        }

        .badge-aligned {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-discuss {
            background-color: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
            border: 1px solid #fd7e14;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-priority {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        @media print {
            .navbar, .nav-tabs, .btn {
                display: none !important;
            }

            .tab-pane {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }

            .container {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
            <div class="container-fluid">
                <span class="navbar-brand">TeamHACK</span>
                <div class="collapse navbar-collapse">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/dashboard">Dashboard</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">Team Member Comparison</h1>
                <h4 class="text-center text-muted mb-4">Working Norms Discussion Guide</h4>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="comparisonTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="side-by-side-tab" data-bs-toggle="tab"
                                    data-bs-target="#side-by-side" type="button" role="tab" aria-selected="true">
                                    Side by Side View
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="conflicts-tab" data-bs-toggle="tab"
                                    data-bs-target="#conflicts-view" type="button" role="tab" aria-selected="false">
                                    Discussion Points Only
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="comparisonTabContent">
                            <div class="tab-pane fade show active" id="side-by-side" role="tabpanel">
                                <div class="alert alert-info mb-4">
                                    <h4 class="alert-heading">Complete Comparison</h4>
                                    <p>This view shows all responses from both team members. Areas with potential conflicts are highlighted.</p>
                                    <p class="mb-0 small">Fields are organized to match the structure of the TeamHACK form.</p>
                                </div>
                                <div id="comparison-content"></div>
                            </div>
                            <div class="tab-pane fade" id="conflicts-view" role="tabpanel">
                                <div id="conflicts-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 mb-5 text-center">
            <a href="/dashboard" class="btn btn-primary">Back to Dashboard</a>
            <button id="print-comparison" class="btn btn-secondary ms-2">Print Comparison</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Get data from server
            const result = {{ result | tojson }};
            const form1 = {{ form1 | tojson }};
            const form2 = {{ form2 | tojson }};
            const user1 = {{ user1 | tojson }};
            const user2 = {{ user2 | tojson }};

            // Form sections structure
            const formSections = [
                {
                    title: "My Best Working Self at a Glance",
                    fields: [
                        "timing_preference", "working_hours", "relax_preference",
                        "brainstorming_preference", "feeling_preference", "chat_scheduling",
                        "communication_medium", "updating_style", "asking_style",
                        "building_preference", "praise_preference"
                    ]
                },
                {
                    title: "The Culture I Come From",
                    fields: [
                        "speaking_preference", "listening_preference", "tough_news_preference",
                        "thinking_preference", "orientation_preference", "leading_preference",
                        "deciding_preference", "trusting_preference", "disagreeing_preference",
                        "scheduling_preference"
                    ]
                },
                {
                    title: "About Me",
                    fields: [
                        "professional_goals", "motivations", "success_definition", "work_life_balance",
                        "strengths", "improvement_areas", "support_growth", "work_preference",
                        "productivity_peaks", "rank_opposing", "rank_supporting", "rank_suggesting",
                        "rank_asking", "rank_relationships", "rank_process", "rank_task",
                        "internal_problem_solving", "decision_making", "stress_signs",
                        "support_preference", "recharge_methods", "work_habits", "rank_equity",
                        "rank_harm", "rank_people", "rank_consistency", "rank_order",
                        "rank_independence", "ocean_openness", "ocean_conscientiousness",
                        "ocean_extroversion", "ocean_agreeableness", "ocean_neuroticism",
                        "misunderstood_aspects", "outside_interests"
                    ]
                },
                {
                    title: "About Us",
                    fields: [
                        "build_trust", "break_trust", "relationship_value", "give_feedback",
                        "receive_feedback", "conflict_approach", "diffuse_defense",
                        "collaboration_preference", "convince_me", "ideal_meeting", "meeting_prep",
                        "meeting_expectations", "preferred_channels", "response_time", "best_times",
                        "currency_language", "receive_updates", "give_updates"
                    ]
                },
                {
                    title: "Self-Added Information",
                    fields: ["self_added"]
                }
            ];

            // Field label mappings
            const fieldLabels = {
                // Core fields
                "timing_preference": "Early Bird vs Night Owl",
                "working_hours": "Set vs Flexible Working Hours",
                "relax_preference": "Relax with Others vs Alone",
                "brainstorming_preference": "External vs Internal Processor",
                "feeling_preference": "Process Events with Others vs Moving On",
                "chat_scheduling": "Scheduled Chats vs Interruptions",
                "communication_medium": "Video/Call vs Text/Slack",
                "updating_style": "Full Story vs Cut to Chase",
                "asking_style": "Full Context vs Direct Needs",
                "building_preference": "Ship Fast & Learn vs Learn First, Then Ship",
                "praise_preference": "Private vs Public Praise",

                // Culture fields
                "speaking_preference": "Explicit vs Implicit Communication",
                "listening_preference": "Literal vs Interpretive Listening",
                "tough_news_preference": "Direct vs Gentle with Tough News",
                "thinking_preference": "Theory First vs Example First",
                "orientation_preference": "Journey vs Destination Focus",
                "leading_preference": "Servant vs Authority Leadership",
                "deciding_preference": "Group vs Leader Decision Making",
                "trusting_preference": "Performance vs Relationship Trust",
                "disagreeing_preference": "Embrace/Confront vs Avoid Disagreement",
                "scheduling_preference": "Plan and Execute vs Flexible Planning",

                // Goal fields
                "professional_goals": "Professional Goals",
                "motivations": "Work Motivations",
                "success_definition": "Definition of Success",
                "work_life_balance": "Work-Life Balance Approach",

                // Strength fields
                "strengths": "Top Strengths",
                "improvement_areas": "Areas for Improvement",
                "support_growth": "Support Needed for Growth",

                // Working style
                "work_preference": "Preferred Work Environment",
                "productivity_peaks": "Productivity Peaks",
                "rank_opposing": "Problem-Solving: Opposing/Challenging",
                "rank_supporting": "Problem-Solving: Supporting/Encouraging",
                "rank_suggesting": "Problem-Solving: Suggesting/Actioning",
                "rank_asking": "Problem-Solving: Asking/Reflecting",
                "rank_relationships": "Priority: Relationships and Trust",
                "rank_process": "Priority: Process Excellence",
                "rank_task": "Priority: Task Completion",
                "internal_problem_solving": "Problem-Solving Approach",
                "decision_making": "Decision-Making Process",

                // Stress and support
                "stress_signs": "Signs of Stress/Overwhelm",
                "support_preference": "Support During Challenges",
                "recharge_methods": "Methods to Recharge",

                // Habits and values
                "work_habits": "Specific Work Habits",
                "rank_equity": "Value: Protect Equity/Fairness",
                "rank_harm": "Value: Avoid Harm",
                "rank_people": "Value: Protect People/In-group",
                "rank_consistency": "Value: Protect Consistency/Purity",
                "rank_order": "Value: Protect Order/Authority",
                "rank_independence": "Value: Protect Independence/Liberty",

                // OCEAN traits
                "ocean_openness": "Personality: Openness",
                "ocean_conscientiousness": "Personality: Conscientiousness",
                "ocean_extroversion": "Personality: Extroversion",
                "ocean_agreeableness": "Personality: Agreeableness",
                "ocean_neuroticism": "Personality: Neuroticism",

                "misunderstood_aspects": "Commonly Misunderstood Aspects",
                "outside_interests": "Life Outside Work",

                // About us
                "build_trust": "Building Trust",
                "break_trust": "Breaking Trust",
                "relationship_value": "Valued in Relationships",
                "give_feedback": "Giving Feedback",
                "receive_feedback": "Receiving Feedback",
                "conflict_approach": "Conflict Approach",
                "diffuse_defense": "Diffusing Defensiveness",
                "collaboration_preference": "Collaboration Preferences",
                "convince_me": "Convincing Approach",
                "ideal_meeting": "Ideal Meeting",
                "meeting_prep": "Meeting Preparation",
                "meeting_expectations": "Meeting Expectations",
                "preferred_channels": "Communication Channels",
                "response_time": "Response Time",
                "best_times": "Best Contact Times",
                "currency_language": "Communication Style",
                "receive_updates": "Receiving Updates",
                "give_updates": "Giving Updates",

                // Self-added
                "self_added": "Additional Information"
            };

            // Value interpretation functions
            function getLikertValue(field, value) {
                if (!value) return "";

                const likertMappings = {
                    "timing_preference": {
                        "1": "Early Bird", "2": "Balanced", "3": "Night Owl"
                    },
                    "working_hours": {
                        "1": "Set Hours", "2": "Somewhat Flexible", "3": "Very Flexible"
                    },
                    "relax_preference": {
                        "1": "With Others", "2": "Either Way", "3": "Alone"
                    },
                    "brainstorming_preference": {
                        "1": "Think Together", "2": "Balanced", "3": "Think Alone"
                    },
                    "feeling_preference": {
                        "1": "Process with Others", "2": "Sometimes", "3": "Move On Quickly"
                    }
                    // Add more as needed
                };

                if (likertMappings[field] && likertMappings[field][value]) {
                    return likertMappings[field][value];
                }

                // Generic likert scale (1-3)
                if (value === "1") return "Low/First Option";
                if (value === "2") return "Medium/Middle Option";
                if (value === "3") return "High/Last Option";

                return value;
            }

            function getRankingValue(field, value) {
                if (!value) return "";

                // Problem solving rankings (1-4)
                if (["rank_opposing", "rank_supporting", "rank_suggesting", "rank_asking"].includes(field)) {
                    if (value === "1") return "Most common (1st)";
                    if (value === "2") return "Common (2nd)";
                    if (value === "3") return "Less common (3rd)";
                    if (value === "4") return "Least common (4th)";
                }

                // Priority rankings (1-3)
                if (["rank_relationships", "rank_process", "rank_task"].includes(field)) {
                    if (value === "1") return "Highest priority (1st)";
                    if (value === "2") return "Medium priority (2nd)";
                    if (value === "3") return "Lowest priority (3rd)";
                }

                // Values rankings (1-6)
                if (["rank_equity", "rank_harm", "rank_people", "rank_consistency", "rank_order", "rank_independence"].includes(field)) {
                    return `Priority ${value} of 6`;
                }

                return `Rank ${value}`;
            }

            function getOceanValue(field, value) {
                if (!value) return "";

                if (typeof value === "string") {
                    value = value.toLowerCase();
                    if (value === "low") return "Low";
                    if (value === "medium") return "Medium";
                    if (value === "high") return "High";
                }

                return value;
            }

            function getFormattedValue(field, value) {
                if (!value) return "";

                // Check field type by name pattern
                if (field.startsWith("ocean_")) {
                    return getOceanValue(field, value);
                } else if (field.startsWith("rank_")) {
                    return getRankingValue(field, value);
                } else if (["1", "2", "3"].includes(value) &&
                          ["timing_preference", "working_hours", "relax_preference",
                           "brainstorming_preference", "feeling_preference", "chat_scheduling",
                           "communication_medium", "updating_style", "asking_style",
                           "building_preference", "praise_preference", "speaking_preference",
                           "listening_preference", "tough_news_preference", "thinking_preference",
                           "orientation_preference", "leading_preference", "deciding_preference",
                           "trusting_preference", "disagreeing_preference", "scheduling_preference"].includes(field)) {
                    return getLikertValue(field, value);
                }

                // Default - just show the value
                return value;
            }

            // Get field label
            function getFieldLabel(field) {
                return fieldLabels[field] || field.replace(/_/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            // Determine conflict status
            function getConflictStatus(field, value1, value2) {
                // Exact match is always aligned
                if (value1 === value2) {
                    return {
                        isConflict: false,
                        status: "aligned",
                        label: "Aligned",
                        class: "badge-aligned"
                    };
                }

                // Check if field is in conflict areas
                if (result.conflict_summary && result.conflict_summary.conflict_areas) {
                    const conflict = result.conflict_summary.conflict_areas.find(area => area.field === field);

                    if (conflict) {
                        if (conflict.is_high_priority) {
                            return {
                                isConflict: true,
                                status: "priority",
                                label: "High Priority",
                                class: "badge-priority"
                            };
                        }
                        return {
                            isConflict: true,
                            status: "discuss",
                            label: "Discuss",
                            class: "badge-discuss"
                        };
                    }
                }

                // Different values but not marked as conflict by engine
                return {
                    isConflict: false,
                    status: "aligned",
                    label: "Aligned",
                    class: "badge-aligned"
                };
            }

            // Render the main comparison
            function renderComparison() {
                const comparisonContent = document.getElementById('comparison-content');
                const conflictsContent = document.getElementById('conflicts-content');

                // Clear existing content
                comparisonContent.innerHTML = '';
                conflictsContent.innerHTML = '';

                // Add conflict introduction
                const conflictIntro = document.createElement('div');
                conflictIntro.className = 'alert alert-info mb-4';
                conflictIntro.innerHTML = `
                    <h4 class="alert-heading">Discussion Points</h4>
                    <p>Below are the areas where ${user1.username} and ${user2.username} have different preferences
                    that may benefit from discussion.</p>
                `;
                conflictsContent.appendChild(conflictIntro);

                // Add conflict summary if conflicts exist
                if (result.conflict_summary && result.conflict_summary.conflict_areas &&
                    result.conflict_summary.conflict_areas.length > 0) {

                    // Count high priority conflicts
                    const highPriorityCount = result.conflict_summary.conflict_areas.filter(
                        c => c.is_high_priority).length;

                    const conflictSummary = document.createElement('div');
                    conflictSummary.className = 'alert alert-warning mb-4';
                    conflictSummary.innerHTML = `
                        <h5>Conflict Summary</h5>
                        <p>Total differences found: ${result.conflict_summary.conflict_areas.length}</p>
                        <p>High priority discussion points: ${highPriorityCount}</p>
                        <p class="mb-0"><strong>Overall assessment:</strong>
                            ${result.conflict_summary.overall_assessment || 'Some differences found that may benefit from discussion'}
                        </p>
                    `;
                    conflictsContent.appendChild(conflictSummary);
                } else {
                    // No conflicts message
                    const noConflicts = document.createElement('div');
                    noConflicts.className = 'alert alert-success';
                    noConflicts.innerHTML = '<p>No significant differences found! These team members appear well-aligned in their working preferences.</p>';
                    conflictsContent.appendChild(noConflicts);
                }

                // Get all fields from both forms (excluding user_id)
                const allFields = new Set([
                    ...Object.keys(form1).filter(key => key !== 'user_id'),
                    ...Object.keys(form2).filter(key => key !== 'user_id')
                ]);

                // Create section fields map
                const sectionFields = {};
                formSections.forEach(section => {
                    sectionFields[section.title] = [];
                });

                // Categorize fields by section
                allFields.forEach(field => {
                    let assigned = false;

                    for (const section of formSections) {
                        if (section.fields.includes(field)) {
                            sectionFields[section.title].push(field);
                            assigned = true;
                            break;
                        }
                    }

                    // If field wasn't found in any section, add to "Other" section
                    if (!assigned) {
                        if (!sectionFields["Other"]) {
                            sectionFields["Other"] = [];
                        }
                        sectionFields["Other"].push(field);
                    }
                });

                // Track if we need an "Other" section
                if (sectionFields["Other"] && sectionFields["Other"].length === 0) {
                    delete sectionFields["Other"];
                }

                // Process each section
                for (const section of formSections) {
                    const sectionTitle = section.title;
                    const fields = sectionFields[sectionTitle];

                    // Skip empty sections
                    if (!fields || fields.length === 0) continue;

                    // Create section header for comparison view
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header';
                    sectionHeader.textContent = sectionTitle;
                    comparisonContent.appendChild(sectionHeader);

                    // Create table for this section
                    const table = document.createElement('table');
                    table.className = 'comparison-table';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th width="30%">Field</th>
                                <th width="25%">${user1.username}</th>
                                <th width="25%">${user2.username}</th>
                                <th width="20%">Status</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    `;
                    comparisonContent.appendChild(table);
                    const tableBody = table.querySelector('tbody');

                    // Variables for conflict section
                    let conflictSectionAdded = false;
                    let conflictTable = null;

                    // Process fields in this section
                    fields.forEach(field => {
                        const value1 = form1[field] || '';
                        const value2 = form2[field] || '';

                        // Skip if both values are empty
                        if (!value1 && !value2) return;

                        // Get formatted values and field label
                        const displayValue1 = getFormattedValue(field, value1);
                        const displayValue2 = getFormattedValue(field, value2);
                        const fieldLabel = getFieldLabel(field);

                        // Determine conflict status
                        const status = getConflictStatus(field, value1, value2);

                        // Create row for comparison view
                        const row = document.createElement('tr');
                        if (status.isConflict) {
                            row.className = 'conflict';
                        }

                        row.innerHTML = `
                            <td>${fieldLabel}</td>
                            <td>${displayValue1}</td>
                            <td>${displayValue2}</td>
                            <td><span class="${status.class}">${status.label}</span></td>
                        `;
                        tableBody.appendChild(row);

                        // Add to conflicts view if it's a conflict
                        if (status.isConflict) {
                            // If this is the first conflict in this section, add section header
                            if (!conflictSectionAdded) {
                                const conflictHeader = document.createElement('div');
                                conflictHeader.className = 'section-header';
                                conflictHeader.textContent = sectionTitle;
                                conflictsContent.appendChild(conflictHeader);

                                // Create conflict table
                                conflictTable = document.createElement('table');
                                conflictTable.className = 'comparison-table';
                                conflictTable.innerHTML = `
                                    <thead>
                                        <tr>
                                            <th width="30%">Field</th>
                                            <th width="25%">${user1.username}</th>
                                            <th width="25%">${user2.username}</th>
                                            <th width="20%">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                `;
                                conflictsContent.appendChild(conflictTable);

                                conflictSectionAdded = true;
                            }

                            // Add conflict row
                            const conflictRow = row.cloneNode(true);
                            conflictTable.querySelector('tbody').appendChild(conflictRow);
                        }
                    });
                }
            }

            // Initial render
            renderComparison();

            // Print button
            document.getElementById('print-comparison').addEventListener('click', function() {
                window.print();
            });
        });
    </script>
</body>
</html>
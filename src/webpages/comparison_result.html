<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamHACK - Detailed Comparison</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .section-header {
            background-color: #e0e0e0;
            padding: 15px;
            margin-top: 30px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .subsection-header {
            background-color: #f1f1f1;
            padding: 10px 15px;
            margin-top: 25px;
            margin-bottom: 15px;
            border-radius: 5px;
            font-weight: 500;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: 500;
        }

        .comparison-table tr.conflict {
            background-color: rgba(255, 0, 0, 0.08);
        }

        .badge-aligned {
            background-color: rgba(25, 135, 84, 0.1);
            color: #198754;
            border: 1px solid #198754;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-discuss {
            background-color: rgba(253, 126, 20, 0.1);
            color: #fd7e14;
            border: 1px solid #fd7e14;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .badge-priority {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            border: 1px solid #dc3545;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        @media print {
            .navbar, .nav-tabs, .btn {
                display: none !important;
            }

            .tab-pane {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }

            .container {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>
    <div class="container mt-4 mb-5">
        <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
    <div class="container-fluid">
        <span class="navbar-brand">TeamHACK</span>
        <a href="/dashboard" class="btn btn-outline-primary btn-sm">Dashboard</a>
    </div>
</nav>

        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">Team Member Comparison</h1>
                <h4 class="text-center text-muted mb-4">Working Norms Discussion Guide</h4>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="comparisonTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="side-by-side-tab" data-bs-toggle="tab"
                                    data-bs-target="#side-by-side" type="button" role="tab" aria-selected="true">
                                    Side by Side View
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="conflicts-tab" data-bs-toggle="tab"
                                    data-bs-target="#conflicts-view" type="button" role="tab" aria-selected="false">
                                    Discussion Points Only
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="comparisonTabContent">
                            <div class="tab-pane fade show active" id="side-by-side" role="tabpanel">
                                <div class="alert alert-info mb-4">
                                    <h4 class="alert-heading">Complete Comparison</h4>
                                    <p>This view shows all responses from both team members. Areas with potential conflicts are highlighted.</p>
                                    <p class="mb-0 small">Fields are organized to match the structure of the TeamHACK form.</p>
                                </div>
                                <div id="comparison-content"></div>
                            </div>
                            <div class="tab-pane fade" id="conflicts-view" role="tabpanel">
                                <div id="conflicts-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 mb-5 text-center">
            <a href="/dashboard" class="btn btn-primary">Dashboard</a>
            <button id="print-comparison" class="btn btn-secondary ms-2">Print Comparison</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Remove any loading overlay that might have persisted
            const overlay = document.getElementById('loading-overlay');
            if (overlay) {
                overlay.remove();
            }
        });

            // Get data from server
            const result = {{ result | tojson }};
            const form1 = {{ form1 | tojson }};
            const form2 = {{ form2 | tojson }};
            const user1 = {{ user1 | tojson }};
            const user2 = {{ user2 | tojson }};

            // Form sections structure
            const formSections = [
                {
                    title: "My Best Working Self at a Glance",
                    fields: [
                        "timing_preference", "working_hours", "relax_preference",
                        "brainstorming_preference", "feeling_preference", "chat_scheduling",
                        "communication_medium", "updating_style", "asking_style",
                        "building_preference", "praise_preference"
                    ],
                    subsections: {
                        "Timing": ["timing_preference", "working_hours"],
                        "Relaxing & Brainstorming": ["relax_preference", "brainstorming_preference", "feeling_preference"],
                        "Chatting & Communication": ["chat_scheduling", "communication_medium", "updating_style", "asking_style"],
                        "Building & Praise": ["building_preference", "praise_preference"]
                    }
                },
                {
                    title: "The Culture I Come From",
                    fields: [
                        "speaking_preference", "listening_preference", "tough_news_preference",
                        "thinking_preference", "orientation_preference", "leading_preference",
                        "deciding_preference", "trusting_preference", "disagreeing_preference",
                        "scheduling_preference"
                    ],
                    subsections: {
                        "Communication & Thinking": ["speaking_preference", "listening_preference", "tough_news_preference", "thinking_preference"],
                        "Work & Decision-Making": ["orientation_preference", "leading_preference", "deciding_preference", "scheduling_preference", "trusting_preference", "disagreeing_preference"]
                    }
                },
                {
                    title: "Open Ended Detail",
                    fields: [],
                    description: ""
                },
                {
                    title: "About Me",
                    fields: [
                        "professional_goals", "motivations", "success_definition", "work_life_balance",
                        "strengths", "improvement_areas", "support_growth", "work_preference",
                        "productivity_peaks", "rank_opposing", "rank_supporting", "rank_suggesting",
                        "rank_asking", "rank_relationships", "rank_process", "rank_task",
                        "internal_problem_solving", "decision_making", "stress_signs",
                        "support_preference", "recharge_methods", "work_habits", "rank_equity",
                        "rank_harm", "rank_people", "rank_consistency", "rank_order",
                        "rank_independence", "ocean_openness", "ocean_conscientiousness",
                        "ocean_extroversion", "ocean_agreeableness", "ocean_neuroticism",
                        "misunderstood_aspects", "outside_interests"
                    ],
                    subsections: {
                        "Goals & Motivation": ["professional_goals", "motivations", "success_definition", "work_life_balance"],
                        "Strengths and Opportunities / Glow and Grow": ["strengths", "improvement_areas", "support_growth"],
                        "Working Style": [
                            "work_preference", "productivity_peaks",
                            "rank_opposing", "rank_supporting", "rank_suggesting", "rank_asking",
                            "rank_relationships", "rank_process", "rank_task",
                            "internal_problem_solving", "decision_making"
                        ],
                        "Stress & Support": ["stress_signs", "support_preference", "recharge_methods"],
                        "Habits, Quirks, and More!": [
                            "work_habits",
                            "rank_equity", "rank_harm", "rank_people", "rank_consistency", "rank_order", "rank_independence",
                            "ocean_openness", "ocean_conscientiousness", "ocean_extroversion", "ocean_agreeableness", "ocean_neuroticism",
                            "misunderstood_aspects", "outside_interests"
                        ]
                    }
                },
                {
                    title: "About Us",
                    fields: [
                        "build_trust", "break_trust", "relationship_value", "give_feedback",
                        "receive_feedback", "conflict_approach", "diffuse_defense",
                        "collaboration_preference", "convince_me", "ideal_meeting", "meeting_prep",
                        "meeting_expectations", "preferred_channels", "response_time", "best_times",
                        "currency_language", "receive_updates", "give_updates"
                    ],
                    subsections: {
                        "Trust & Relationships": ["build_trust", "break_trust", "relationship_value"],
                        "Feedback and Conflict": ["give_feedback", "receive_feedback", "conflict_approach",
                            "diffuse_defense"],
                        "Working and Meeting Preferences": ["collaboration_preference", "convince_me", "ideal_meeting", "meeting_prep", "meeting_expectations"],
                        "Communication Preferences": ["preferred_channels", "response_time", "best_times",
                            "currency_language", "receive_updates", "give_updates"]
                    }
                },
                {
                    title: "Self-Added Information",
                    fields: ["self_added"]
                }
            ];

            // Field label mappings
            const fieldLabels = {
                // Core fields
                "timing_preference": "Early Bird - Night Owl",
                "working_hours": "Set Working Hours - Flexible Working Hours",
                "relax_preference": "Relax with Others - Relax Alone",
                "brainstorming_preference": "Think Together (External Processor) - Think Alone (Internal Processor)",
                "feeling_preference": "Process What Happened with You - Move On",
                "chat_scheduling": "Schedule to Chat - Interrupt (I Welcome It!)",
                "communication_medium": "Video Chat/Call - Slack/Text",
                "updating_style": "Full Story - Cut to Chase",
                "asking_style": "Full Context - Direct Needs",
                "building_preference": "Ship It and Learn - Learn and then Ship It",
                "praise_preference": "Private Praise - Public Praise",

                // Culture fields
                "speaking_preference": "If I don't say it, don't assume it - Read the subtext",
                "listening_preference": "Take literally - With grain of salt",
                "tough_news_preference": "Be direct - Hint gently",
                "thinking_preference": "Theory first (Deduction) - Example first (Induction)",
                "orientation_preference": "Journey (Experience) - Destination (Accomplish)",
                "leading_preference": "Servant Leadership (Flipped Pyramid/Flat) - Authority Leadership (Typical Pyramid/Top-Down)",
                "deciding_preference": "Group Decision Making - Leader Decision Making",
                "trusting_preference": "Performance Trust - Relationship Trust",
                "disagreeing_preference": "Embrace/Confront Disagreement - Avoid Disagreement",
                "scheduling_preference": "Plan and Execute - Flexible Planning",

                // Goal fields
                "professional_goals": "My professional goals",
                "motivations": "What motivates me at work",
                "success_definition": "How I define success",
                "work_life_balance": "My approach to work-life balance",

                // Strength fields
                "strengths": "What I believe are my top strengths",
                "improvement_areas": "Areas where I'd like to improve",
                "support_growth": "How others can support my growth",

                // Working style
                "work_preference": "My preferred work environment",
                "productivity_peaks": "When I'm most productive",
                "rank_opposing": "How often I approach problems by opposing/challenging",
                "rank_supporting": "How often I approach problems by supporting/encouraging",
                "rank_suggesting": "How often I approach problems by suggesting/actioning",
                "rank_asking": "How often I approach problems by asking/reflecting",
                "rank_relationships": "How I prioritize relationships and trust",
                "rank_process": "How I prioritize process excellence",
                "rank_task": "How I prioritize task completion",
                "internal_problem_solving": "My problem-solving approach",
                "decision_making": "My decision-making process",

                // Stress and support
                "stress_signs": "Signs I'm stressed or overwhelmed",
                "support_preference": "How to support me during challenges",
                "recharge_methods": "How I recharge",

                // Habits and values
                "work_habits": "Specific work habits or preferences",
                "rank_equity": "Value: Protect Equity/Fairness",
                "rank_harm": "Value: Avoid Harm",
                "rank_people": "Value: Protect People/In-group",
                "rank_consistency": "Value: Protect Consistency/Purity",
                "rank_order": "Value: Protect Order/Authority",
                "rank_independence": "Value: Protect Independence/Liberty",

                // OCEAN traits
                "ocean_openness": "Personality: Openness",
                "ocean_conscientiousness": "Personality: Conscientiousness",
                "ocean_extroversion": "Personality: Extroversion",
                "ocean_agreeableness": "Personality: Agreeableness",
                "ocean_neuroticism": "Personality: Neuroticism",

                "misunderstood_aspects": "What others commonly misunderstand about me",
                "outside_interests": "My life outside work",

                // About us
                "build_trust": "How to build trust with me",
                "break_trust": "How to break trust with me",
                "relationship_value": "What I value in working relationships",
                "give_feedback": "How I prefer to give feedback",
                "receive_feedback": "How I prefer to receive feedback",
                "conflict_approach": "My approach to conflict",
                "diffuse_defense": "How to diffuse my defensiveness",
                "collaboration_preference": "How I prefer to collaborate",
                "convince_me": "Best way to convince me",
                "ideal_meeting": "My ideal meeting",
                "meeting_prep": "My meeting preparation preference",
                "meeting_expectations": "My expectations for meetings",
                "preferred_channels": "My preferred communication channels",
                "response_time": "My expected response time",
                "best_times": "Best times to contact me",
                "currency_language": "My communication style",
                "receive_updates": "How I prefer to receive updates",
                "give_updates": "How I prefer to give updates",

                // Self-added
                "self_added": "Additional Information"
            };

            // Value interpretation functions
            function getLikertValue(field, value) {
                if (!value) return "";

                const likertMappings = {
                    "timing_preference": {
                        "1": "Early Bird", "2": "Balanced", "3": "Night Owl"
                    },
                    "working_hours": {
                        "1": "Set Hours", "2": "Somewhat Flexible", "3": "Very Flexible"
                    },
                    "relax_preference": {
                        "1": "With Others", "2": "Either Way", "3": "Alone"
                    },
                    "brainstorming_preference": {
                        "1": "Think Together", "2": "Balanced", "3": "Think Alone"
                    },
                    "feeling_preference": {
                        "1": "Process with Others", "2": "Sometimes", "3": "Move On Quickly"
                    },
                    "chat_scheduling": {
                        "1": "Schedule to Chat", "2": "Mix of Both", "3": "Interrupt (I Welcome It!)"
                    },
                    "communication_medium": {
                        "1": "Video Chat/Call", "2": "Mix of Both", "3": "Slack/Text"
                    },
                    "updating_style": {
                        "1": "Full Story", "2": "Balanced", "3": "Cut to Chase"
                    },
                    "asking_style": {
                        "1": "Full Context", "2": "Some Context", "3": "Direct Needs"
                    },
                    "building_preference": {
                        "1": "Ship It and Learn", "2": "Balanced Approach", "3": "Learn and then Ship It"
                    },
                    "praise_preference": {
                        "1": "Private Praise", "2": "Mix of Both", "3": "Public Praise"
                    },
                    "speaking_preference": {
                        "1": "If I don't say it, don't assume it", "2": "Balanced", "3": "Read the subtext"
                    },
                    "listening_preference": {
                        "1": "Take literally", "2": "Mixed", "3": "With grain of salt"
                    },
                    "tough_news_preference": {
                        "1": "Be direct", "2": "Balanced", "3": "Hint gently"
                    },
                    "thinking_preference": {
                        "1": "Theory first (Deduction)", "2": "Balanced", "3": "Example first (Induction)"
                    },
                    "orientation_preference": {
                        "1": "Journey (Experience)", "2": "Balanced", "3": "Destination (Accomplish)"
                    },
                    "leading_preference": {
                        "1": "Servant Leadership (Flipped Pyramid/Flat)", "2": "Balanced", "3": "Authority Leadership (Typical Pyramid/Top-Down)"
                    },
                    "deciding_preference": {
                        "1": "Group Decision", "2": "Collaborative", "3": "Leader Decision"
                    },
                    "trusting_preference": {
                        "1": "Performance Trust", "2": "Balanced", "3": "Relationship Trust"
                    },
                    "disagreeing_preference": {
                        "1": "Embrace/Confront", "2": "Selective", "3": "Avoid Disagreement"
                    },
                    "scheduling_preference": {
                        "1": "Plan and Execute", "2": "Adaptable", "3": "Flexible Planning"
                    }
                };

                if (likertMappings[field] && likertMappings[field][value]) {
                    return likertMappings[field][value];
                }

                // Generic likert scale (1-3)
                if (value === "1") return "Low/First Option";
                if (value === "2") return "Medium/Middle Option";
                if (value === "3") return "High/Last Option";

                return value;
            }

            function getRankingValue(field, value) {
                if (!value) return "";

                // Problem solving rankings (1-4)
                if (["rank_opposing", "rank_supporting", "rank_suggesting", "rank_asking"].includes(field)) {
                    if (value === "1") return "Most common (1st)";
                    if (value === "2") return "Common (2nd)";
                    if (value === "3") return "Less common (3rd)";
                    if (value === "4") return "Least common (4th)";
                }

                // Priority rankings (1-3)
                if (["rank_relationships", "rank_process", "rank_task"].includes(field)) {
                    if (value === "1") return "Highest priority (1st)";
                    if (value === "2") return "Medium priority (2nd)";
                    if (value === "3") return "Lowest priority (3rd)";
                }

                // Values rankings (1-6)
                if (["rank_equity", "rank_harm", "rank_people", "rank_consistency", "rank_order", "rank_independence"].includes(field)) {
                    return `Priority ${value} of 6`;
                }

                return `Rank ${value}`;
            }

            function getOceanValue(field, value) {
                if (!value) return "";

                if (typeof value === "string") {
                    value = value.toLowerCase();
                    if (value === "low") return "Low";
                    if (value === "medium") return "Medium";
                    if (value === "high") return "High";
                }

                return value;
            }

            function getFormattedValue(field, value) {
                if (!value) return "";

                // Check field type by name pattern
                if (field.startsWith("ocean_")) {
                    return getOceanValue(field, value);
                } else if (field.startsWith("rank_")) {
                    return getRankingValue(field, value);
                } else if (["1", "2", "3"].includes(value) &&
                          ["timing_preference", "working_hours", "relax_preference",
                           "brainstorming_preference", "feeling_preference", "chat_scheduling",
                           "communication_medium", "updating_style", "asking_style",
                           "building_preference", "praise_preference", "speaking_preference",
                           "listening_preference", "tough_news_preference", "thinking_preference",
                           "orientation_preference", "leading_preference", "deciding_preference",
                           "trusting_preference", "disagreeing_preference", "scheduling_preference"].includes(field)) {
                    return getLikertValue(field, value);
                }

                // Default - just show the value
                return value;
            }

            // Get field label
            function getFieldLabel(field) {
                return fieldLabels[field] || field.replace(/_/g, ' ')
                    .split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
            }

            // Determine conflict status
            function getConflictStatus(field, value1, value2) {
                // Exact match is always aligned
                if (value1 === value2) {
                    return {
                        isConflict: false,
                        status: "aligned",
                        label: "Aligned",
                        class: "badge-aligned"
                    };
                }

                // Check if field is in conflict areas
                if (result.conflict_summary && result.conflict_summary.conflict_areas) {
                    const conflict = result.conflict_summary.conflict_areas.find(area => area.field === field);

                    if (conflict) {
                        if (conflict.assessment === "high_priority") {
                            return {
                                isConflict: true,
                                status: "priority",
                                label: "High Priority",
                                class: "badge-priority"
                            };
                        }
                        else if (conflict.assessment === "discuss") {
                            return {
                                isConflict: true,
                                status: "discuss",
                                label: "Discuss",
                                class: "badge-discuss"
                            };
                        }
                    }
                }

                // Different values but not marked as conflict by engine
                return {
                    isConflict: false,
                    status: "aligned",
                    label: "Aligned",
                    class: "badge-aligned"
                };
            }

            // Render the main comparison
            function renderComparison() {
                const comparisonContent = document.getElementById('comparison-content');
                const conflictsContent = document.getElementById('conflicts-content');

                // Clear existing content
                comparisonContent.innerHTML = '';
                conflictsContent.innerHTML = '';

                // Add conflict introduction
                const conflictIntro = document.createElement('div');
                conflictIntro.className = 'alert alert-info mb-4';
                conflictIntro.innerHTML = `
                    <h4 class="alert-heading">Discussion Points</h4>
                    <p>Below are the areas where ${user1.username} and ${user2.username} have different preferences
                    that may benefit from discussion.</p>
                `;
                conflictsContent.appendChild(conflictIntro);

                // Add conflict summary if conflicts exist
                if (result.conflict_summary && result.conflict_summary.conflict_areas &&
                    result.conflict_summary.conflict_areas.length > 0) {

                    // Count high priority conflicts
                    const highPriorityCount = result.conflict_summary.conflict_areas.filter(
                        c => c.assessment === "high_priority").length;

                    const conflictSummary = document.createElement('div');
                    conflictSummary.className = 'alert alert-warning mb-4';
                    conflictSummary.innerHTML = `
                        <h5>Conflict Summary</h5>
                        <p>Total differences found: ${result.conflict_summary.conflict_areas.length}</p>
                        <p>High priority discussion points: ${highPriorityCount}</p>
                        <p class="mb-0"><strong>Overall assessment:</strong>
                            ${result.conflict_summary.overall_assessment || 'Some differences found that may benefit from discussion'}
                        </p>
                    `;
                    conflictsContent.appendChild(conflictSummary);
                } else {
                    // No conflicts message
                    const noConflicts = document.createElement('div');
                    noConflicts.className = 'alert alert-success';
                    noConflicts.innerHTML = '<p>No significant differences found! These team members appear well-aligned in their working preferences.</p>';
                    conflictsContent.appendChild(noConflicts);
                }

                // Get all fields from both forms (excluding user_id)
                const allFields = new Set([
                    ...Object.keys(form1).filter(key => key !== 'user_id'),
                    ...Object.keys(form2).filter(key => key !== 'user_id')
                ]);

                // Create section fields map
                const sectionFields = {};
                formSections.forEach(section => {
                    sectionFields[section.title] = [];
                });

                // Categorize fields by section
                allFields.forEach(field => {
                    let assigned = false;

                    for (const section of formSections) {
                        if (section.fields.includes(field)) {
                            sectionFields[section.title].push(field);
                            assigned = true;
                            break;
                        }
                    }

                    // If field wasn't found in any section, add to "Other" section
                    if (!assigned) {
                        if (!sectionFields["Other"]) {
                            sectionFields["Other"] = [];
                        }
                        sectionFields["Other"].push(field);
                    }
                });

                // Track if we need an "Other" section
                if (sectionFields["Other"] && sectionFields["Other"].length === 0) {
                    delete sectionFields["Other"];
                }

                // ALWAYS create the Open Ended Detail section, regardless of content
                let openEndedAdded = false;

                // Process each section
                for (const section of formSections) {
                    const sectionTitle = section.title;
                    const fields = sectionFields[sectionTitle];

                    // Special handling for "Open Ended Detail" section - always show it
                    if (section.title === "Open Ended Detail") {
                        // Create section header for comparison view
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = 'section-header';
                        sectionHeader.textContent = sectionTitle;
                        comparisonContent.appendChild(sectionHeader);

                        // Track that we've added it
                        openEndedAdded = true;

                        // Also add to conflicts view if needed
                        if (result.conflict_summary && result.conflict_summary.conflict_areas &&
                            result.conflict_summary.conflict_areas.length > 0) {
                            const conflictSectionHeader = document.createElement('div');
                            conflictSectionHeader.className = 'section-header';
                            conflictSectionHeader.textContent = sectionTitle;
                            conflictsContent.appendChild(conflictSectionHeader);
                        }
                        continue;
                    }

                    // Skip empty sections (except Open Ended Detail, which we handled above)
                    if (!fields || fields.length === 0) {
                        continue;
                    }

                    // Create section header for comparison view
                    const sectionHeader = document.createElement('div');
                    sectionHeader.className = 'section-header';
                    sectionHeader.textContent = sectionTitle;
                    comparisonContent.appendChild(sectionHeader);

                    // Add description if available
                    if (section.description) {
                        const descriptionEl = document.createElement('div');
                        descriptionEl.className = 'alert alert-secondary mb-4';
                        descriptionEl.innerHTML = section.description;
                        comparisonContent.appendChild(descriptionEl);
                    }

                    // If subsections exist for this section, organize by subsections
                    if (section.subsections) {
                        // For each subsection
                        for (const [subsectionTitle, subsectionFields] of Object.entries(section.subsections)) {
                            // Create subsection header
                            const subsectionHeader = document.createElement('div');
                            subsectionHeader.className = 'subsection-header';
                            subsectionHeader.textContent = subsectionTitle;
                            comparisonContent.appendChild(subsectionHeader);

                            // Create table for this subsection
                            const table = document.createElement('table');
                            table.className = 'comparison-table';
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th width="30%">Field</th>
                                        <th width="25%">${user1.username}</th>
                                        <th width="25%">${user2.username}</th>
                                        <th width="20%">Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            comparisonContent.appendChild(table);
                            const tableBody = table.querySelector('tbody');

                            // Fill the table with fields
                            subsectionFields.forEach(field => {
                                if (!fields.includes(field)) return; // Skip if not in this section's fields

                                const value1 = form1[field] || '';
                                const value2 = form2[field] || '';

                                // Skip if both values are empty
                                if (!value1 && !value2) return;

                                // Get formatted values and field label
                                const displayValue1 = getFormattedValue(field, value1);
                                const displayValue2 = getFormattedValue(field, value2);
                                const fieldLabel = getFieldLabel(field);

                                // Determine conflict status
                                const status = getConflictStatus(field, value1, value2);

                                // Create row
                                const row = document.createElement('tr');
                                if (status.isConflict) {
                                    row.className = 'conflict';
                                }

                                row.innerHTML = `
                                    <td>${fieldLabel}</td>
                                    <td>${displayValue1}</td>
                                    <td>${displayValue2}</td>
                                    <td><span class="${status.class}">${status.label}</span></td>
                                `;
                                tableBody.appendChild(row);

                                // Add to conflicts view if it's a conflict
                                if (status.isConflict) {
                                    addToConflictsView(field, fieldLabel, displayValue1, displayValue2, status, sectionTitle, subsectionTitle);
                                }
                            });
                        }
                    } else {
                        // Standard section without subsections
                        // Create table for this section
                        const table = document.createElement('table');
                        table.className = 'comparison-table';
                        table.innerHTML = `
                            <thead>
                                <tr>
                                    <th width="30%">Field</th>
                                    <th width="25%">${user1.username}</th>
                                    <th width="25%">${user2.username}</th>
                                    <th width="20%">Status</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        `;
                        comparisonContent.appendChild(table);
                        const tableBody = table.querySelector('tbody');

                        // Process fields in this section
                        fields.forEach(field => {
                            const value1 = form1[field] || '';
                            const value2 = form2[field] || '';

                            // Skip if both values are empty
                            if (!value1 && !value2) return;

                            // Get formatted values and field label
                            const displayValue1 = getFormattedValue(field, value1);
                            const displayValue2 = getFormattedValue(field, value2);
                            const fieldLabel = getFieldLabel(field);

                            // Determine conflict status
                            const status = getConflictStatus(field, value1, value2);

                            // Create row for comparison view
                            const row = document.createElement('tr');
                            if (status.isConflict) {
                                row.className = 'conflict';
                            }

                            row.innerHTML = `
                                <td>${fieldLabel}</td>
                                <td>${displayValue1}</td>
                                <td>${displayValue2}</td>
                                <td><span class="${status.class}">${status.label}</span></td>
                            `;
                            tableBody.appendChild(row);

                            // Add to conflicts view if it's a conflict
                            if (status.isConflict) {
                                addToConflictsView(field, fieldLabel, displayValue1, displayValue2, status, sectionTitle);
                            }
                        });
                    }
                }

                // Helper function to add conflicts to conflicts view
                function addToConflictsView(field, fieldLabel, displayValue1, displayValue2, status, sectionTitle, subsectionTitle = null) {
                    // Keep track of added sections and subsections
                    if (!this.conflictSections) {
                        this.conflictSections = {};
                    }

                    // If section not already added
                    if (!this.conflictSections[sectionTitle]) {
                        const sectionHeader = document.createElement('div');
                        sectionHeader.className = 'section-header';
                        sectionHeader.textContent = sectionTitle;
                        conflictsContent.appendChild(sectionHeader);

                        this.conflictSections[sectionTitle] = {
                            added: true,
                            subsections: {}
                        };
                    }

                    // If subsection title provided
                    if (subsectionTitle) {
                        if (!this.conflictSections[sectionTitle].subsections[subsectionTitle]) {
                            const subsectionHeader = document.createElement('div');
                            subsectionHeader.className = 'subsection-header';
                            subsectionHeader.textContent = subsectionTitle;
                            conflictsContent.appendChild(subsectionHeader);

                            // Create table
                            const table = document.createElement('table');
                            table.className = 'comparison-table';
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th width="30%">Field</th>
                                        <th width="25%">${user1.username}</th>
                                        <th width="25%">${user2.username}</th>
                                        <th width="20%">Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            conflictsContent.appendChild(table);

                            this.conflictSections[sectionTitle].subsections[subsectionTitle] = {
                                table: table
                            };
                        }

                        // Add row to subsection table
                        const row = document.createElement('tr');
                        row.className = 'conflict';
                        row.innerHTML = `
                            <td>${fieldLabel}</td>
                            <td>${displayValue1}</td>
                            <td>${displayValue2}</td>
                            <td><span class="${status.class}">${status.label}</span></td>
                        `;
                        this.conflictSections[sectionTitle].subsections[subsectionTitle].table.querySelector('tbody').appendChild(row);
                    } else {
                        // No subsection
                        if (!this.conflictSections[sectionTitle].table) {
                            const table = document.createElement('table');
                            table.className = 'comparison-table';
                            table.innerHTML = `
                                <thead>
                                    <tr>
                                        <th width="30%">Field</th>
                                        <th width="25%">${user1.username}</th>
                                        <th width="25%">${user2.username}</th>
                                        <th width="20%">Status</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            `;
                            conflictsContent.appendChild(table);

                            this.conflictSections[sectionTitle].table = table;
                        }

                        // Add row to section table
                        const row = document.createElement('tr');
                        row.className = 'conflict';
                        row.innerHTML = `
                            <td>${fieldLabel}</td>
                            <td>${displayValue1}</td>
                            <td>${displayValue2}</td>
                            <td><span class="${status.class}">${status.label}</span></td>
                        `;
                        this.conflictSections[sectionTitle].table.querySelector('tbody').appendChild(row);
                    }
                }
            }

            // Initial render
            renderComparison();

            // Print button
            document.getElementById('print-comparison').addEventListener('click', function() {
                window.print();
            });
    </script>
</body>
</html>
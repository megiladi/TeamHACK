<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamHACK - Working Norms Discussions</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row mb-5">
            <div class="col-md-12 text-center">
                <h1>TeamHACK</h1>
                <p class="lead">Turn eventual conflicts into upfront goodwill and team strengths</p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h2>Fill Out Your Working Norms Form</h2>
                    </div>
                    <div class="card-body">
                        <p>Share your work preferences and style to help build better team dynamics.</p>
                        <form id="userSelectForm" class="mb-3">
                            <div class="mb-3">
                                <label for="userId" class="form-label">Select Your User</label>
                                <select class="form-select" id="userId">
                                    <option value="" selected>Choose your username...</option>
                                    <!-- Will be populated via JavaScript -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Go to Form</button>
                        </form>
                        <hr>
                        <h5>New User?</h5>
                        <form id="createUserForm">
                            <div class="mb-3">
                                <label for="username" class="form-label">Username</label>
                                <input type="text" class="form-control" id="username" required>
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <button type="submit" class="btn btn-success">Create User</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card h-100">
                    <div class="card-header">
                        <h2>Compare Team Members</h2>
                    </div>
                    <div class="card-body">
                        <p>Generate a comparison between two team members to identify potential conflicts and strengths.</p>
                        <form id="compareUsersForm">
                            <div class="mb-3">
                                <label for="username1" class="form-label">First Team Member</label>
                                <select class="form-select" id="username1" required>
                                    <option value="" selected>Select first user...</option>
                                    <!-- Will be populated via JavaScript -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="username2" class="form-label">Second Team Member</label>
                                <select class="form-select" id="username2" required>
                                    <option value="" selected>Select second user...</option>
                                    <!-- Will be populated via JavaScript -->
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary">Compare</button>
                        </form>

                        <hr>

                        <h5>Recent Comparisons</h5>
                        <ul class="list-group" id="recentComparisons">
                            <!-- Will be populated via JavaScript -->
                            <li class="list-group-item text-center">Loading recent comparisons...</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load users for the dropdowns
        async function loadUsers() {
            try {
                const response = await fetch('/users');
                const users = await response.json();

                // Populate user select elements
                const userSelects = document.querySelectorAll('#userId, #username1, #username2');

                userSelects.forEach(select => {
                    // Keep the first option
                    const firstOption = select.querySelector('option');

                    // Clear existing options
                    select.innerHTML = '';
                    select.appendChild(firstOption);

                    // Add user options
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.username;
                        option.textContent = user.username;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Load recent comparisons
        async function loadRecentComparisons() {
            try {
                const response = await fetch('/comparisons');
                const comparisons = await response.json();

                const comparisonsList = document.getElementById('recentComparisons');
                comparisonsList.innerHTML = '';

                if (comparisons.length === 0) {
                    comparisonsList.innerHTML = '<li class="list-group-item text-center">No comparisons found</li>';
                    return;
                }

                // Display only the 5 most recent comparisons
                const recentComparisons = comparisons.slice(0, 5);

                // Process each comparison
                for (const comparison of recentComparisons) {
                    try {
                        // Get the detailed comparison with user info
                        const detailResponse = await fetch(`/comparisons/${comparison.id}`);
                        const detailData = await detailResponse.json();

                        // Create list item
                        const li = document.createElement('li');
                        li.className = 'list-group-item';

                        // Use the user information from the detailed response
                        const user1 = detailData.users.user1.username;
                        const user2 = detailData.users.user2.username;

                        li.innerHTML = `
                            <a href="/comparisons/${comparison.id}/view" class="d-block">
                                ${user1} vs ${user2}
                            </a>
                            <small class="text-muted">Comparison ID: ${comparison.id}</small>
                        `;

                        comparisonsList.appendChild(li);
                    } catch (error) {
                        console.error(`Error processing comparison ${comparison.id}:`, error);
                    }
                }

                // If we couldn't process any comparisons
                if (comparisonsList.children.length === 0) {
                    comparisonsList.innerHTML = '<li class="list-group-item text-center">Error loading comparison details</li>';
                }

            } catch (error) {
                console.error('Error loading comparisons:', error);
                const comparisonsList = document.getElementById('recentComparisons');
                comparisonsList.innerHTML = '<li class="list-group-item text-danger">Error loading comparisons</li>';
            }
        }

        // Handle form submissions
        document.getElementById('userSelectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('userId').value;
            if (username) {
                window.location.href = `/fill_form?user=${username}`;
            }
        });

        document.getElementById('createUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;

            try {
                const response = await fetch('/users', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email })
                });

                const result = await response.json();

                if (response.ok) {
                    alert('User created successfully!');
                    document.getElementById('username').value = '';
                    document.getElementById('email').value = '';
                    loadUsers();
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error creating user:', error);
                alert('Error creating user. Please try again.');
            }
        });

        document.getElementById('compareUsersForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username1 = document.getElementById('username1').value;
            const username2 = document.getElementById('username2').value;

            if (!username1 || !username2 || username1 === username2) {
                alert('Please select two different users');
                return;
            }

            try {
                const response = await fetch('/compare_users/usernames', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username1, username2 })
                });

                const result = await response.json();

                if (response.ok) {
                    window.location.href = `/comparisons/${result.id}/view`;
                } else {
                    alert(`Error: ${result.error}`);
                }
            } catch (error) {
                console.error('Error comparing users:', error);
                alert('Error comparing users. Please try again.');
            }
        });

        // Load data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            loadRecentComparisons();
        });
    </script>
</body>
</html>